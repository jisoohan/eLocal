{% extends "eLocal_app/base.html" %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>eLocal - Store Search</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  </head>

  <body>
    {% block content %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-danger text-center col-xs-10 col-xs-offset-1">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>{{ message|escape }}</strong>
          </div>
        {% endfor %}
      {% endif %}
      <div class="col-xs-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title text-center">Store Search</h2>
          </div>
          <div class="panel-body text-center">
            <form form="form" class="form-inline" method="get" action="{% url 'eLocal_app.views.searchStore' %}">
              <div class="form-group">
                <label for="{{ searchForm.name.id_for_label }}" class="control-label">Name: </label>
                {% render_field searchForm.name class="form-control" type="text" %}
              </div>
              <button id="storeSearch" type="submit" class="btn btn-default btn-success">Search</button>
              <a id="storeSearchReset" href="{% url 'eLocal_app.views.storeSearchPage' %}" class="btn btn-default">Reset</a>
            </form>
          </div>
        </div>
      </div>
      {% if stores %}
        <div class="container-fluid col-xs-12">
          <div class="table-hover col-xs-4 scrolly">
            {% for store in stores %}
              <div class="list-group-item">
                <h4 class="list-group-item-heading">
                  {{store.name}}
                  {% if store.has_card %}
                    <span class="badge">Card</span>
                  {% endif %}
                  <button type="button" class="btn btn-default pull-right" id="showStoreBtn{{forloop.counter}}">Info</button>
                </h4>
                <p class="list-group-item-text">
                  {{store.address}}<br/>
                  {{store.city}}, {{store.state}} {{store.zip_code}}
                </p>
              </div>
            {% endfor %}
          </div>
          {% for store in stores %}
            <div class="col-xs-8 hidden" id="showStore{{forloop.counter}}">
              <div class="panel panel-default scrolly">
                <div class="panel-heading">
                  <h2 class="panel-title text-center">{{store.name}}</h2>
                </div>
                <div class="panel-body text-center">
                  <h4>Address</h4>
                  <address>
                    {{store.address}}<br/>
                    {{store.city}}, {{store.state}} {{store.zip_code}}
                  </address>
                  <h4>Products</h4>
                  <table class="table table-condensed">
                    <thead>
                      <tr>
                        <th class="text-left">Name</th>
                        <th class="text-right">Price</th>
                        <th class="text-right">Add to Cart</th>
                        <th class="text-right">Edit Price</th>
                        <th class="text-right">Delete Product</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if store.product_list %}
                        {% for product in store.product_list %}
                          <tr>
                            <td class="text-left">{{product.name}}</td>
                            <td class="text-right">${{product.price}}</td>
                            <td class="text-right"><a href="{% url 'eLocal_app.views.addCart' product.id store.id %}" class="btn btn-default">Add</a></td>
                            <td class="text-right"><a href="" data-toggle="modal" data-target="#editprice{{product.id}}{{store.id}}" class="btn btn-default">Edit</a></td>
                            <td class="text-right"><a href="" data-toggle="modal" data-target="#deleteProductFromStore{{product.id}}{{store.id}}" class="btn btn-default">Delete</a></td>
                          </tr>
                        {% endfor %}
                      {% endif %}
                    </tbody>
                  </table>
                </div>
                <div class="modal-footer">
                  <a href="" data-toggle="modal" data-target="#editstore{{forloop.counter}}" class="btn btn-default pull-left">Edit Store</a>
                  <a href="" data-toggle="modal" data-target="#deleteStore{{forloop.counter}}" class="btn btn-default pull-right">Delete Store</a>
                </div>
              </div>
              <div id="deleteStore{{forloop.counter}}" class="modal modal-vcenter fade" role="dialog">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-body text-center">
                      <h3>Delete Store?</h3>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default pull-left" data-dismiss="modal">No</button>
                      <a href="{% url 'eLocal_app.views.deleteStore' store.id %}" class="btn btn-default pull-right">Yes</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        {% for editStoreForm in editStoreForms %}
          <div id="editstore{{forloop.counter}}" class="modal modal-vcenter fade" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h3 class="modal-title text-center">Edit Store</h3>
                </div>
                <div class="modal-body">
                  <form form="form" class="form-horizontal text-center" method="post" action="{% url 'eLocal_app.views.updateStore' editStoreForm.0 %}" autocomplete="off">
                    <div class="form-group">
                      <div class="col-xs-12"><input id="autocomplete" class="form-control" placeholder="Enter store address" type="text" autocomplete="off"></input></div>
                    </div>
                    <div class="form-group">
                      <label for="storeName" class="control-label col-xs-2">Name</label>
                      <div class="col-xs-10">{% render_field editStoreForm.1.store_name class="form-control" type="text" id="storeName" autocomplete="off" %}</div>
                    </div>
                    <div class="form-group">
                      <label for="street_number" class="control-label col-xs-2">Street #</label>
                      <div class="col-xs-2">{% render_field editStoreForm.1.street_number class="form-control" type="text" id="street_number" autocomplete="off" %}</div>
                      <label for="route" class="control-label col-xs-2">Address</label>
                      <div class="col-xs-6">{% render_field editStoreForm.1.street_address class="form-control" type="text" id="route" autocomplete="off" %}</div>
                    </div>
                    <div class="form-group">
                      <label for="locality" class="control-label col-xs-2">City</label>
                      <div class="col-xs-5">{% render_field editStoreForm.1.city class="form-control" type="text" id="locality" autocomplete="off" %}</div>
                      <label for="administrative_area_level_1" class="control-label col-xs-2">State</label>
                      <div class="col-xs-3">{% render_field editStoreForm.1.state class="form-control" type="text" id="administrative_area_level_1" autocomplete="off" %}</div>
                    </div>
                    <div class="form-group">
                      <label for="postal_code" class="control-label col-xs-2">Zipcode</label>
                      <div class="col-xs-5">{% render_field editStoreForm.1.zip_code class="form-control" type="text" id="postal_code" autocomplete="off" %}</div>
                      <label for="country" class="control-label col-xs-2">Country</label>
                      <div class="col-xs-3">{% render_field editStoreForm.1.country class="form-control" type="text" id="country" autocomplete="off" %}</div>
                    </div>
                    <div class="form-group">
                      <label for="has_card" class="control-label col-xs-2">Membership Card</label>
                      <div class="col-xs-1">{% render_field editStoreForm.1.has_card class="form-control" id="has_card" type="checkbox" %}</div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default btn-danger pull-left col-xs-2" data-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-default btn-success pull-right col-xs-4">Update Store</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
        {% for editPriceForm in editPriceForms %}
          <div id="editprice{{editPriceForm.0}}{{editPriceForm.1}}" class="modal modal-vcenter fade" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h3 class="modal-title text-center">Edit Price</h3>
                </div>
                <div class="modal-body">
                  <form form="form" class="form-horizontal text-center" method="post" action="{% url 'eLocal_app.views.updatePrice' editPriceForm.0 editPriceForm.1 %}">
                    <div class="form-group">
                      <label for="price" class="control-label col-xs-3">Price</label>
                      <div class="col-xs-9">
                        {% render_field editPriceForm.2.price class="form-control" type="text" id="price" autocomplete="off" %}
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default btn-danger pull-left col-xs-2" data-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-default btn-success pull-right col-xs-4">Update Price</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <div id="deleteProductFromStore{{editPriceForm.0}}{{editPriceForm.1}}" class="modal modal-vcenter fade" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-body text-center">
                  <h3>Delete Product?</h3>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default pull-left" data-dismiss="modal">No</button>
                  <a href="{% url 'eLocal_app.views.deleteProductFromStore' editPriceForm.0 editPriceForm.1 %}" class="btn btn-default pull-right">Yes</a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    {% endblock %}

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_eOeXynkGshNoWp8mNgec-RxEeV8U9vk&libraries=places"></script>
    <script type="text/javascript">
      {% block javascript %}
        var store_count = {{stores|length}};
        var productsLength = {{editPriceForms|length}};
        var lastBtnClickedNum = -1;
        function initializeStoreEditForm(j) {
          return function(e) {
            $('#editstore' + j + ' #street_number').focus(function(e) {
              $(this).blur();
            });
            $('#editstore' + j + ' #route').focus(function(e) {
              $(this).blur();
            });
            $('#editstore' + j + ' #locality').focus(function(e) {
              $(this).blur();
            });
            $('#editstore' + j + ' #administrative_area_level_1').focus(function(e) {
              $(this).blur();
            });
            $('#editstore' + j + ' #country').focus(function(e) {
              $(this).blur();
            });
            $('#editstore' + j + ' #postal_code').focus(function(e) {
              $(this).blur();
            });
            var options = {
              componentRestrictions: {country: 'us'}
            };
            var autocomplete = new google.maps.places.Autocomplete(document.getElementById('editstore' + j).querySelector('#autocomplete'), options);
            google.maps.event.addListener(autocomplete, "place_changed", function() {
              var componentForm = {
                street_number: 'short_name',
                route: 'long_name',
                locality: 'long_name',
                administrative_area_level_1: 'short_name',
                country: 'short_name',
                postal_code: 'short_name'
              };
              $('#editstore' + j + ' #street_number').val('');
              $('#editstore' + j + ' #route').val('');
              $('#editstore' + j + ' #locality').val('');
              $('#editstore' + j + ' #administrative_area_level_1').val('');
              $('#editstore' + j + ' #country').val('');
              $('#editstore' + j + ' #postal_code').val('');
              // Get the place details from the autocomplete object.
              var place = autocomplete.getPlace();
              document.getElementById('editstore' + j).querySelector('#storeName').value = place.name
              // Get each component of the address from the place details
              // and fill the corresponding field on the form.
              for (var i = 0; i < place.address_components.length; i++) {
                var addressType = place.address_components[i].types[0];
                if (componentForm[addressType]) {
                  var val = place.address_components[i][componentForm[addressType]];
                  document.getElementById('editstore' + j).querySelector('#' + addressType).value = val;
                }
              }
            });
          }
        }
        function submitStoreEditForm(j) {
          return function(e) {
            var storeName = $('#editstore' + j + ' #storeName');
            var street_number = $('#editstore' + j + ' #street_number');
            var street_address = $('#editstore' + j + ' #route');
            var locality = $('#editstore' + j + ' #locality');
            var administrative_area_level_1 = $('#editstore' + j + ' #administrative_area_level_1');
            var postal_code = $('#editstore' + j + ' #postal_code');
            var country = $('#editstore' + j + ' #country');
            if (!storeName.val()) {
              e.preventDefault();
              storeName.closest('.form-group').removeClass('has-success').addClass('has-error');
            } else {
              storeName.closest('.form-group').removeClass('has-error').addClass('has-success');
            }
            if (!street_number.val() || !street_address.val()) {
              e.preventDefault();
              street_number.closest('.form-group').removeClass('has-success').addClass('has-error');
            } else {
              street_number.closest('.form-group').removeClass('has-error').addClass('has-success');
            }
            if (!locality.val() || !administrative_area_level_1.val()) {
              e.preventDefault();
              locality.closest('.form-group').removeClass('has-success').addClass('has-error');
            } else {
              locality.closest('.form-group').removeClass('has-error').addClass('has-success');
            }
            if (!postal_code.val() || !country.val()) {
              e.preventDefault();
              postal_code.closest('.form-group').removeClass('has-success').addClass('has-error');
            } else {
              postal_code.closest('.form-group').removeClass('has-error').addClass('has-success');
            }
          }
        }
        function resetStoreEditForm(j, storeName, street_number, route, locality, administrative_area_level_1, country, postal_code, has_card) {
          return function(e) {
            $('#editstore' + j + ' #autocomplete').val('');
            $('#editstore' + j + ' #storeName').val(storeName);
            $('#editstore' + j + ' #street_number').val(street_number);
            $('#editstore' + j + ' #route').val(route);
            $('#editstore' + j + ' #locality').val(locality);
            $('#editstore' + j + ' #administrative_area_level_1').val(administrative_area_level_1);
            $('#editstore' + j + ' #country').val(country);
            $('#editstore' + j + ' #postal_code').val(postal_code);
            document.getElementById('editstore' + j).querySelector('#has_card').checked = has_card;
            $('#editstore' + j + ' #storeName').closest('.form-group').removeClass('has-error').removeClass('has-success');
            $('#editstore' + j + ' #street_number').closest('.form-group').removeClass('has-error').removeClass('has-success');
            $('#editstore' + j + ' #locality').closest('.form-group').removeClass('has-error').removeClass('has-success');
            $('#editstore' + j + ' #country').closest('.form-group').removeClass('has-error').removeClass('has-success');
          }
        }
        function submitPriceEditForm(product_id, store_id) {
          return function(e) {
            var price = $('#editprice' + product_id + store_id + ' #price');
            if (!price.val()) {
              e.preventDefault();
              price.closest('.form-group').removeClass('has-success').addClass('has-error');
            } else {
              price.closest('.form-group').removeClass('has-error').addClass('has-success');
            }
          }
        }
        function resetPriceEditForm(product_id, store_id, price) {
          return function(e) {
            $('#editprice' + product_id + store_id + ' #price').val(price);
            $('#editprice' + product_id + store_id + ' #price').closest('.form-group').removeClass('has-error').removeClass('has-success');
          }
        }
        function showStoreInfo(j) {
          return function(e) {
            var currBtn = $('#showStoreBtn' + j);
            if (lastBtnClickedNum == -1) {
              $('#showStore' + j).removeClass('hidden');
              lastBtnClickedNum = j;
            } else if (j == lastBtnClickedNum) {
              if ($('#showStore' + j).hasClass('hidden')) {
                $('#showStore' + j).removeClass('hidden');
              } else {
                $('#showStore' + j).addClass('hidden');
              }
            } else {
              $('#showStore' + lastBtnClickedNum).addClass('hidden');
              $('#showStore' + j).removeClass('hidden');
              lastBtnClickedNum = j;
            }
          }
        }
        $(document).ready(function(e) {
          for (var i = 1; i <= store_count; i++) {
            $('#showStoreBtn' + i).click(showStoreInfo(i));
            var org_storeName = $('#editstore' + i + ' #storeName').val();
            var org_street_number = $('#editstore' + i + ' #street_number').val();
            var org_route = $('#editstore' + i + ' #route').val();
            var org_locality = $('#editstore' + i + ' #locality').val();
            var org_administrative_area_level_1 = $('#editstore' + i + ' #administrative_area_level_1').val();
            var org_country = $('#editstore' + i + ' #country').val();
            var org_postal_code = $('#editstore' + i + ' #postal_code').val();
            var org_has_card = document.getElementById('editstore' + i).querySelector('#has_card').checked;
            $('#editstore' + i).click(initializeStoreEditForm(i));
            $('#editstore' + i).on("submit", submitStoreEditForm(i));
            $("#editstore" + i).on("hidden.bs.modal", resetStoreEditForm(i, org_storeName, org_street_number, org_route, org_locality, org_administrative_area_level_1, org_country, org_postal_code, org_has_card));
          }
          for (var k = 0; k < productsLength.length; k++) {
            var org_price = $('#editprice' + productsLength[k][0] + productsLength[k][1] + ' #price').val();
            $('#editprice' + productsLength[k][0] + productsLength[k][1]).on("submit", submitPriceEditForm(productsLength[k][0], productsLength[k][1]));
            $('#editprice' + productsLength[k][0] + productsLength[k][1]).on("hidden.bs.modal", resetPriceEditForm(productsLength[k][0], productsLength[k][1], org_price));
          }
        });
      {% endblock %}
    </script>
  </body>
</html>

